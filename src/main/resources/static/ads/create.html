<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Create Advertisement</title>
    <style>
        body {
            font-family: Arial;
            margin: 50px;
            background: #f9f9f9;
        }

        form {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        input, textarea, select, button {
            width: 100%;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        button {
            background: #007bff;
            color: white;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }

        .msg {
            margin-top: 15px;
            font-weight: bold;
        }

        .nav-buttons {
            margin-bottom: 20px;
        }

        .nav-buttons button {
            width: auto;
            display: inline-block;
            margin-right: 10px;
        }
    </style>
</head>
<body>
<h1>Create Advertisement</h1>

<div class="nav-buttons">
    <button onclick="history.back()" style="background:#6c757d; color:white;">Ortga</button>
    <button onclick="window.location.href='/'" style="background:#343a40; color:white;">Asosiy ekran</button>
</div>

<form id="createForm">
    <input type="text" id="brand" placeholder="Brand">
    <input type="text" id="model" placeholder="Model">
    <select id="condition" required>
        <option value="">Select Condition</option>
        <option value="NEW">New</option>
        <option value="USED">Used</option>
    </select>
    <input type="text" id="phoneMemory" placeholder="Phone Memory">
    <input type="text" id="color" placeholder="Color">
    <input type="number" id="price" placeholder="Price" required>
    <textarea id="description" placeholder="Description" required></textarea>
    <input type="text" id="phoneNumber" placeholder="Phone Number">
    <input type="text" id="location" placeholder="Location">
    <input type="file" id="files" multiple accept="image/*" required>
    <button type="submit">Create</button>
</form>

<p class="msg" id="message"></p>

<script>
    document.getElementById("createForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const msg = document.getElementById("message");
        msg.textContent = "";

        try {
            const token = localStorage.getItem("token");
            if (!token) throw new Error("Please login first");

            // Advertisement DTO
            const adDto = {
                description: document.getElementById("description").value,
                price: parseFloat(document.getElementById("price").value),
                brand: document.getElementById("brand").value,
                model: document.getElementById("model").value,
                color: document.getElementById("color").value,
                phoneNumber: document.getElementById("phoneNumber").value,
                phoneMemory: document.getElementById("phoneMemory").value,
                condition: document.getElementById("condition").value,
                location: document.getElementById("location").value
            };

            // Create advertisement
            const adResponse = await fetch("/api/v1/ads", {
                method: "POST",
                headers: {
                    "Authorization": "Bearer " + token,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(adDto)
            });

            if (!adResponse.ok) {
                const errorText = await adResponse.text();
                throw new Error("Ad creation failed: " + errorText);
            }

            const createdAd = await adResponse.json();

            // Upload images
            const files = document.getElementById("files").files;
            if (files.length > 0) {
                const formData = new FormData();
                formData.append("adId", createdAd.id.toString());
                for (let i = 0; i < files.length; i++) formData.append("files", files[i]);

                const resImg = await fetch("/api/v1/images/upload", {
                    method: "POST",
                    headers: { "Authorization": "Bearer " + token },
                    body: formData
                });

                if (!resImg.ok) {
                    const errorText = await resImg.text();
                    throw new Error("Image upload failed: " + errorText);
                }
            }

            msg.style.color = "green";
            msg.textContent = "Advertisement created successfully!";
            setTimeout(() => (window.location.href = "/ads/list"), 1200);

        } catch (err) {
            msg.style.color = "red";
            msg.textContent = err.message;
        }
    });
</script>
</body>
</html>
